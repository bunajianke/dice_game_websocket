(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/multiplayer/multiplayer"],{"00a0":function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=n("1dc8"),r=n("2f62"),s=n("6a96");function i(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function a(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(Object(n),!0).forEach((function(e){c(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var u=function(){n.e("components/uni-popup/uni-popup").then(function(){return resolve(n("fa7d"))}.bind(null,n)).catch(n.oe)},l={components:{uniPopup:u},data:function(){return{socketOpen:!1,optionType:"create",points:"",currentStatus:"-1",allPlayerShaked:!1,allPlayerOpend:!1,allPlayerReady:!1,capOpen:!1,shaking:!1,innerAudioContext:null}},computed:a({},(0,r.mapState)(["userInfo","playerList","userInfoPermitted","roomId"]),{pointsArr:function(){return this.points.split("")}}),onLoad:function(t){return console.log(t),t.roomId&&this.userInfoPermitted?(this.optionType="join",this.$store.state.roomId=t.roomId,this.setRoomTitle(t.roomId),void this.infoRegister()):t.roomId&&!this.userInfoPermitted?(this.optionType="join",this.$store.state.roomId=t.roomId,this.setRoomTitle(t.roomId),void this.$refs.permitted.open()):void(t.roomId||!this.userInfoPermitted?t.roomId||this.userInfoPermitted||this.$refs.permitted.open():this.infoRegister())},onHide:function(){console.log("房间已隐藏")},beforeDestroy:function(){t.closeSocket({success:function(t){console.log("关闭socket",t)}})},mounted:function(){this.innerAudioContext=t.createInnerAudioContext(),this.innerAudioContext.autoplay=!1,this.innerAudioContext.src="https://hkb.weishuapay.com/update/1683.wav",this.innerAudioContext.onPlay((function(){console.log("开始播放")})),this.innerAudioContext.onError((function(t){console.log(t.errMsg),console.log(t.errCode)}))},methods:{oneMoreRound:function(){this.allPlayerOpend&&this.sendSocketMessage(4,"重置房间，再来一局")},quitRoom:function(){(0,s.confirm)("确定离开游戏房间？").then((function(e){e.confirm&&t.switchTab({url:"/pages/diceTwo/diceTwo"})}))},setRoomTitle:function(e){t.setNavigationBarTitle({title:"房间号："+e})},infoRegister:function(){var t=this;(0,o.playRegister)({img:this.userInfo.avatarUrl,name:this.userInfo.nickName,city:this.userInfo.city,openId:this.userInfo.openId}).then((function(e){console.log("信息注册",e),"0000"==e.code&&("create"==t.optionType?t.toCreateGameRoom():"join"==t.optionType&&(0,o.joinRoom)({openId:t.userInfo.openId,roomId:t.roomId}).then((function(e){t.websocketStart().then((function(e){e.socketOpen&&(t.setRoomTitle(t.roomId),t.sendSocketMessage(-1,"加入房间，发送我的信息"))})).catch((function(t){console.log(t)}))})))}))},toCreateGameRoom:function(){var t=this;(0,o.createRoom)({openId:this.userInfo.openId}).then((function(e){console.log("创建房间",e),"0000"==e.code&&(t.$store.state.roomId=e.roomId,t.setRoomTitle(e.roomId),t.websocketStart().then((function(e){e.socketOpen&&t.sendSocketMessage(-1,"创建房间，发送我的信息")})))}))},websocketStart:function(){var e=this;return new Promise((function(n,o){t.connectSocket({url:"wss://hkb2.weishuapay.com"}),t.onSocketOpen((function(){e.socketOpen=!0,n({socketOpen:!0})})),t.onSocketError((function(t){console.log("err",t),o({socketOpen:!1})})),t.onSocketMessage((function(n){console.log("广播:",JSON.parse(n.data));var o=JSON.parse(n.data);"0000"==o.code&&"update"==o.state&&(o.msg&&e.$refs.anRef.show(o.msg),e.currentStatus=o.status,1===o.data.length&&(e.allPlayerShaked=!0),"-2"===o.status&&(0,s.alert)("当前连接已断开").then((function(e){e.confirm&&t.switchTab({url:"/pages/diceTwo/diceTwo"})})),o.data.length&&o.data.every((function(t){return"0"===t.status}))&&(e.allPlayerReady=!0,console.log(e.allPlayerReady)),o.data.length>=2&&e.checkAllPlayerStatus(o.data)&&(e.allPlayerShaked=!0),"2"===o.status&&(e.currentStatus="4",e.points="",e.capOpen=!1,e.allPlayerOpend=!1,e.allPlayerReady=!1,e.allPlayerShaked=!1),o.data.length&&o.data.every((function(t){return"2"===t.status}))&&(e.allPlayerOpend=!0),e.$store.dispatch("updatePlayerList",e.dealWithPlayerList(o.data)),console.log(e.playerList))}))}))},checkAllPlayerStatus:function(t){return t.length&&t.every((function(t){return"1"===t.status}))},dealWithPlayerList:function(t){return t.forEach((function(t,e){"string"===typeof t.points&&(t.points=t.points.split(""))})),t.sort((function(t,e){return t.timestamp-e.timestamp}))},sendSocketMessage:function(e,n){var o="roomId=".concat(this.roomId,";status=").concat(e,";name=").concat(this.userInfo.nickName,";img=").concat(this.userInfo.avatarUrl,";openId=").concat(this.userInfo.openId,";point=").concat(this.points);t.sendSocketMessage({data:o,success:function(t){console.log(n,t)}})},getUserInfo:function(){var e=this;t.getUserInfo({success:function(t){console.log("获取用户信息",t),e.$store.state.userInfoPermitted=!0,e.$store.state.userInfo=t.userInfo,e.$store.state.userInfo.openId=t.signature,e.$refs.permitted.close(),e.infoRegister()}})},gameReady:function(){this.socketOpen&&(this.capOpen=!1,this.sendSocketMessage(0,"准备"))},shake:function(){var t=this;this.shaking=!0,this.innerAudioContext.play(),wx.vibrateLong({success:function(){console.log("vibration")}}),setTimeout((function(){t.shaking=!1}),1500),this.points="";for(var e=0;e<6;e++)this.points+=this.randomNum(1,6);this.points=this.points.split("").sort((function(t,e){return t-e})).join(""),console.log(this.points),this.socketOpen&&this.sendSocketMessage(1,"摇骰子")},openCap:function(){this.socketOpen&&this.sendSocketMessage(2,"公布点数")},randomNum:function(t,e){return Math.floor(Math.random()*(e-t+1))+t}},filters:{setStatus:function(t){switch(t){case"-1":return"未准备";case"0":return"已准备";case"1":return"已摇骰盅";case"2":return"开";default:break}},setDiceSrc:function(t){return"../../static/little_dice/".concat(t,"@2x.png")}},onShareAppMessage:function(){return{title:"来玩个骰子~",path:"/pages/multiplayer/multiplayer?roomId="+this.$store.state.roomId,imageUrl:o.sharePicUrl}}};e.default=l}).call(this,n("543d")["default"])},"207a":function(t,e,n){"use strict";n.r(e);var o=n("4c6e"),r=n("bb4a");for(var s in r)"default"!==s&&function(t){n.d(e,t,(function(){return r[t]}))}(s);n("c996");var i,a=n("f0c5"),c=Object(a["a"])(r["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],i);e["default"]=c.exports},"4c6e":function(t,e,n){"use strict";var o={"uni-popup":()=>n.e("components/uni-popup/uni-popup").then(n.bind(null,"fa7d")),"an-layer":()=>n.e("components/an-layer/an-layer").then(n.bind(null,"924f"))},r=function(){var t=this,e=t.$createElement,n=(t._self._c,t.__map(t.playerList,(function(e,n){var o=t.__map(e.points,(function(e,n){var o=t._f("setDiceSrc")(e);return{$orig:t.__get_orig(e),f0:o}})),r=t._f("setStatus")(e.status);return{$orig:t.__get_orig(e),l0:o,f1:r}}))),o=t.__map(t.pointsArr,(function(e,n){var o=t._f("setDiceSrc")(e);return{$orig:t.__get_orig(e),f2:o}}));t._isMounted||(t.e0=function(e){"1"===t.currentStatus&&!t.shaking&&(t.capOpen=!t.capOpen)}),t.$mp.data=Object.assign({},{$root:{l1:n,l2:o}})},s=[];n.d(e,"b",(function(){return r})),n.d(e,"c",(function(){return s})),n.d(e,"a",(function(){return o}))},7705:function(t,e,n){"use strict";(function(t){n("0d58"),n("921b");o(n("66fd"));var e=o(n("207a"));function o(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,n("543d")["createPage"])},a2cd:function(t,e,n){},bb4a:function(t,e,n){"use strict";n.r(e);var o=n("00a0"),r=n.n(o);for(var s in o)"default"!==s&&function(t){n.d(e,t,(function(){return o[t]}))}(s);e["default"]=r.a},c996:function(t,e,n){"use strict";var o=n("a2cd"),r=n.n(o);r.a}},[["7705","common/runtime","common/vendor"]]]);